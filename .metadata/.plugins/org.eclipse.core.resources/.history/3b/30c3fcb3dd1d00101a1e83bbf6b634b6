package wordtutor;

import javax.swing.*;
import javax.swing.filechooser.FileNameExtensionFilter;
import java.awt.*;
import java.awt.event.*;
import java.io.*;
import java.net.URI;
import java.net.URISyntaxException;
import java.net.URL;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Random;
import java.util.Scanner;

public class WordTutor {

    private static String DATA_FILE = "data.dat"; // 기본 데이터 파일 경로
    private static String currentDelimiter = "@@@"; // 현재 사용 중인 구분자
    private static List<Question> allQuestions = new ArrayList<>(); // 모든 문제 저장
    private static List<Question> currentQuestions = new ArrayList<>(); // 현재 학습에 사용될 문제 (랜덤)
    private static int currentQuestionIndex = 0;
    private static JFrame studyFrame;
    private static JLabel questionLabel;
    private static JTextField answerField;
    private static JTextArea resultTextArea;
    private static TrayIcon trayIcon;
    private static boolean answerShown = false;
    private static Point initialClick;
    private static Point frameLocation = null;
    private static final int INITIAL_WIDTH = 350;
    private static final int INITIAL_HEIGHT = 150;
    private static final Random random = new Random();

    private static class Question {
        String question;
        String answer;

        public Question(String question, String answer) {
            this.question = question;
            this.answer = answer;
        }
    }

    public static void main(String[] args) {
        // AWT 이벤트 스레드에서 GUI 생성 및 실행
        SwingUtilities.invokeLater(() -> {
            if (!SystemTray.isSupported()) {
                System.out.println("SystemTray is not supported");
                return;
            }

            PopupMenu popup = new PopupMenu();
            MenuItem startItem = new MenuItem("학습 시작");
            MenuItem openDataItem = new MenuItem("데이터 파일 열기");
            MenuItem createDataItem = new MenuItem("데이터 파일 변환 저장");
            popup.add(startItem);
            popup.add(openDataItem);
            popup.add(createDataItem);
            popup.addSeparator(); // 구분선 추가
            MenuItem blogItem = new MenuItem("제작자 블로그"); // 블로그 연결 메뉴
            MenuItem exitItem = new MenuItem("종료");

            blogItem.addActionListener(e -> openBlog());
            exitItem.addActionListener(e -> {
                SystemTray.getSystemTray().remove(trayIcon);
                System.exit(0);
            });
            startItem.addActionListener(e -> showStudyWindow());
            openDataItem.addActionListener(e -> openDataFileDialog());
            createDataItem.addActionListener(e -> showConvertAndSaveDialog());

            popup.add(blogItem); // 블로그 메뉴 추가
            popup.add(exitItem);


            // 트레이 아이콘 설정
            URL imageUrl = ClassLoader.getSystemResource("icon.png");
            if (imageUrl == null) {
                System.err.println("Error: wordtutor/resources/icon.png not found!");
                // 기본 이미지 로드 또는 프로그램 종료 등의 대체 처리 고려
                return;
            }
            Image image = Toolkit.getDefaultToolkit().getImage(imageUrl);
            trayIcon = new TrayIcon(image, "WordTutor", popup);
            trayIcon.setImageAutoSize(true);

            try {
                SystemTray.getSystemTray().add(trayIcon);
            } catch (AWTException e) {
                System.out.println("TrayIcon could not be added.");
            }

            loadQuestions(DATA_FILE);
            showStudyWindow();
        });
    }

    private static void openBlog() {
        try {
            Desktop.getDesktop().browse(new URI("https://tutoreducto.tistory.com/"));
        } catch (IOException | URISyntaxException e) {
            JOptionPane.showMessageDialog(null, "블로그를 열 수 없습니다.", "오류", JOptionPane.ERROR_MESSAGE);
            e.printStackTrace();
        }
    }

    private static void openDataFileDialog() {
        JFileChooser fileChooser = new JFileChooser();
        FileNameExtensionFilter filter = new FileNameExtensionFilter("데이터 파일 (*.dat)", "dat");
        fileChooser.setFileFilter(filter);
        int returnVal = fileChooser.showOpenDialog(null);
        if (returnVal == JFileChooser.APPROVE_OPTION) {
            File selectedFile = fileChooser.getSelectedFile();
            DATA_FILE = selectedFile.getAbsolutePath();
            loadQuestions(DATA_FILE);
            JOptionPane.showMessageDialog(null, selectedFile.getName() + " 파일을 열었습니다.", "알림", JOptionPane.INFORMATION_MESSAGE);
            currentQuestionIndex = 0;
            if (studyFrame != null && studyFrame.isVisible()) {
                showQuestion();
            }
        }
    }

    private static void loadQuestions(String filePath) {
        loadQuestions(filePath, "@@@"); // 기본 구분자 사용
    }

    private static void loadQuestions(String filePath, String delimiter) {
        allQuestions.clear();
        currentQuestions.clear();
        currentDelimiter = delimiter; // 현재 구분자 업데이트
        try (Scanner scanner = new Scanner(new File(filePath), StandardCharsets.UTF_8)) {
            while (scanner.hasNextLine()) {
                String line = scanner.nextLine().trim();
                if (!line.isEmpty()) {
                    String[] parts = line.split(delimiter);
                    if (parts.length >= 2) {
                        allQuestions.add(new Question(parts[0].trim(), parts[1].trim()));
                    } else {
                        System.err.println("잘못된 형식의 줄 발견: " + line);
                    }
                }
            }
            currentQuestions = new ArrayList<>(allQuestions);
            Collections.shuffle(currentQuestions);
            currentQuestionIndex = 0;
            if (studyFrame != null && studyFrame.isVisible()) {
                showQuestion();
            }
        } catch (FileNotFoundException e) {
            JOptionPane.showMessageDialog(null, filePath + " 파일을 찾을 수 없습니다.", "오류", JOptionPane.ERROR_MESSAGE);
        } catch (IOException e) {
            JOptionPane.showMessageDialog(null, filePath + " 파일을 읽는 중 오류가 발생했습니다.", "오류", JOptionPane.ERROR_MESSAGE);
            e.printStackTrace();
        }
    }

    private static void showConvertAndSaveDialog() {
        JFileChooser fileChooser = new JFileChooser();
        FileNameExtensionFilter filter = new FileNameExtensionFilter("텍스트 파일 (*.txt, *.csv 등)", "txt", "csv", "*");
        fileChooser.setFileFilter(filter);
        int returnVal = fileChooser.showOpenDialog(null);
        if (returnVal == JFileChooser.APPROVE_OPTION) {
            File inputFile = fileChooser.getSelectedFile();
            String delimiter = JOptionPane.showInputDialog(null, inputFile.getName() + " 파일의 구분자를 입력하세요:", ",");
            if (delimiter != null && !delimiter.isEmpty()) {
                String outputFileName = JOptionPane.showInputDialog(null, "저장할 파일 이름을 입력하세요 (확장자 .dat):", inputFile.getName().replaceFirst("[.][^.]+$", "") + ".dat");
                if (outputFileName != null && !outputFileName.trim().isEmpty()) {
                    File outputFile = new File(outputFileName.trim());
                    convertAndSaveData(inputFile, outputFile, delimiter);
                } else {
                    JOptionPane.showMessageDialog(null, "저장할 파일 이름을 입력해주세요.", "알림", JOptionPane.WARNING_MESSAGE);
                }
            } else {
                JOptionPane.showMessageDialog(null, "구분자가 입력되지 않았습니다.", "알림", JOptionPane.WARNING_MESSAGE);
            }
        }
    }

    private static void convertAndSaveData(File inputFile, File outputFile, String delimiter) {
        try (Scanner scanner = new Scanner(inputFile, StandardCharsets.UTF_8);
             FileWriter writer = new FileWriter(outputFile, StandardCharsets.UTF_8)) {
            while (scanner.hasNextLine()) {
                String line = scanner.nextLine().trim();
                if (!line.isEmpty()) {
                    String[] parts = line.split(delimiter);
                    if (parts.length >= 2) {
                        writer.write(parts[0].trim() + "@@@" + parts[1].trim() + "\n");
                    } else {
                        System.err.println(inputFile.getName() + " 파일의 형식이 올바르지 않습니다: " + line);
                    }
                }
            }
            JOptionPane.showMessageDialog(null, inputFile.getName() + " 파일을 " + outputFile.getName() + " 로 변환하여 저장했습니다.", "알림", JOptionPane.INFORMATION_MESSAGE);
            DATA_FILE = outputFile.getAbsolutePath();
            currentDelimiter = "@@@"; // 변환 후 구분자는 "@@@"
            loadQuestions(DATA_FILE);
        } catch (IOException e) {
            JOptionPane.showMessageDialog(null, "파일 변환 및 저장 중 오류가 발생했습니다.", "오류", JOptionPane.ERROR_MESSAGE);
            e.printStackTrace();
        }
    }

    private static void showStudyWindow() {
        if (studyFrame == null || !studyFrame.isShowing()) {
            studyFrame = new JFrame("WordTutor");
            studyFrame.setUndecorated(true);
            studyFrame.setDefaultCloseOperation(JFrame.HIDE_ON_CLOSE);
            studyFrame.setLayout(new BorderLayout());
            studyFrame.setResizable(false);

            JPanel titleBar = new JPanel(new FlowLayout(FlowLayout.LEFT));
            titleBar.addMouseListener(new MouseAdapter() {
                public void mousePressed(MouseEvent e) {
                    initialClick = e.getPoint();
                    studyFrame.getComponentAt(initialClick);
                }
            });
            titleBar.addMouseMotionListener(new MouseMotionAdapter() {
                @Override
                public void mouseDragged(MouseEvent e) {
                    int thisX = studyFrame.getLocation().x;
                    int thisY = studyFrame.getLocation().y;
                    int xMoved = e.getX() - initialClick.x;
                    int yMoved = e.getY() - initialClick.y;
                    studyFrame.setLocation(thisX + xMoved, thisY + yMoved);
                    frameLocation = studyFrame.getLocation();
                }
            });
            studyFrame.add(titleBar, BorderLayout.NORTH);

            questionLabel = new JLabel("", SwingConstants.CENTER);
            questionLabel.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));
            studyFrame.add(questionLabel, BorderLayout.CENTER);

            JPanel inputPanel = new JPanel(new BorderLayout());
            answerField = new JTextField(30);
            answerField.setHorizontalAlignment(JTextField.CENTER);
            inputPanel.add(answerField, BorderLayout.NORTH);

            resultTextArea = new JTextArea(5, 30);
            resultTextArea.setLineWrap(true);
            resultTextArea.setWrapStyleWord(true);
            resultTextArea.setEditable(true); // 초기 상태를 편집 가능으로 설정 (데이터 파일 열람 편의성)
            JScrollPane resultScrollPane = new JScrollPane(resultTextArea);
            inputPanel.add(resultScrollPane, BorderLayout.SOUTH);

            studyFrame.add(inputPanel, BorderLayout.SOUTH);

            answerField.addActionListener(e -> {
                if (answerShown) {
                    showQuestion();
                } else {
                    checkAnswer();
                }
            });

            showQuestion();
            studyFrame.setSize(INITIAL_WIDTH, studyFrame.getPreferredSize().height);
            if (frameLocation != null) {
                studyFrame.setLocation(frameLocation);
            } else {
                studyFrame.setLocationRelativeTo(null);
            }
            studyFrame.setVisible(true);
        } else {
            studyFrame.toFront();
        }
    }

    private static void showQuestion() {
        answerShown = false;
        resultTextArea.setText("");
        resultTextArea.setEditable(false); // 학습 중에는 편집 불가
        answerField.setEnabled(true);
        answerField.setEditable(true);
        if (!currentQuestions.isEmpty()) {
            if (currentQuestionIndex >= currentQuestions.size()) {
                Collections.shuffle(currentQuestions);
                currentQuestionIndex = 0;
            }
            questionLabel.setText(currentQuestions.get(currentQuestionIndex).question);
            answerField.setText("");
            adjustFrameSize();
            answerField.requestFocusInWindow();
        } else {
            questionLabel.setText("데이터 파일을 확인해주세요.");
            answerField.setEnabled(false);
            answerField.setEditable(false);
        }
    }

    private static void checkAnswer() {
        if (!answerShown && !currentQuestions.isEmpty()) {
            String userAnswer = answerField.getText().trim();
            String correctAnswer = currentQuestions.get(currentQuestionIndex).answer;

            resultTextArea.setText("정답: '" + correctAnswer + "'\n입력: '" + userAnswer + "'");
            if (userAnswer.equals(correctAnswer)) {
                resultTextArea.setForeground(Color.BLUE);
            } else {
                resultTextArea.setForeground(Color.RED);
            }
            adjustFrameSize();
            answerShown = true;
            currentQuestionIndex++;
        }
    }

    private static void adjustFrameSize() {
        if (studyFrame != null) {
            int preferredHeight = studyFrame.getPreferredSize().height;
            studyFrame.setSize(INITIAL_WIDTH, preferredHeight);
            studyFrame.setLocation(studyFrame.getLocation());
        }
    }
}